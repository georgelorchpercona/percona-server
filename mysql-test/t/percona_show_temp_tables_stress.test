--source include/have_innodb.inc
--source include/have_myisam.inc
--source include/has_tokudb.inc

CREATE USER event_runner@localhost;

SET @saved_event_scheduler = @@GLOBAL.event_scheduler;
SET GLOBAL event_scheduler = ON;

delimiter |;
CREATE DEFINER=event_runner@localhost EVENT query_temp_tables ON SCHEDULE AT CURRENT_TIMESTAMP
DO
  WHILE TRUE DO
    SELECT * FROM INFORMATION_SCHEMA.GLOBAL_TEMPORARY_TABLES;
  END WHILE|
delimiter ;|

--let $i=400
--echo # Creating 400 temp tables with each of MyISAM, InnoDB, MEMORY, and possibly TokuDB
--disable_query_log
while ($i)
{
  --eval CREATE TEMPORARY TABLE tmp_myisam_$i (a VARCHAR(256)) ENGINE=MyISAM
  --eval CREATE TEMPORARY TABLE tmp_innodb_$i (a VARCHAR(256)) ENGINE=InnoDB
  --eval CREATE TEMPORARY TABLE tmp_memory_$i (a VARCHAR(256)) ENGINE=MEMORY
  if ($HAS_TOKUDB)
  {
    --eval CREATE TEMPORARY TABLE tmp_tokudb_$i (a VARCHAR(256)) ENGINE=TokuDB
  }
  --dec $i
}
--enable_query_log
--let $table_count=`SELECT COUNT(*) FROM INFORMATION_SCHEMA.GLOBAL_TEMPORARY_TABLES`
if ($HAS_TOKUDB == 0)
{
  if ($table_count != 1200)
  {
    --die ERROR IN TEST: Expected count of I_S.GLOBAL_TEMPORARY_TABLES to be 1200.
  }
}
if ($HAS_TOKUDB == 1)
{
  if ($table_count != 1600)
  {
    --die ERROR IN TEST: Expected count of I_S.GLOBAL_TEMPORARY_TABLES to be 1600.
  }
}

--let $i=400
--echo # Dropping the temp tables
--disable_query_log
while ($i)
{
  --eval DROP TEMPORARY TABLE tmp_myisam_$i
  --eval DROP TEMPORARY TABLE tmp_innodb_$i
  --eval DROP TEMPORARY TABLE tmp_memory_$i
  if ($HAS_TOKUDB)
  {
    --eval DROP TEMPORARY TABLE tmp_tokudb_$i
  }
  --dec $i
}
--enable_query_log

--let $ev_thread_id= `SELECT ID FROM INFORMATION_SCHEMA.PROCESSLIST WHERE USER='event_runner'`
--echo KILL QUERY \$ev_thread_id
--disable_query_log
eval KILL QUERY $ev_thread_id;
--enable_query_log

SET GLOBAL event_scheduler = @saved_event_scheduler;

DROP EVENT query_temp_tables;
DROP USER event_runner@localhost;
